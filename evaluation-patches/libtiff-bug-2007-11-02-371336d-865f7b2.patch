--- libtiff//tif_dirwrite.c	2017-02-18 13:30:08.371120871 -0500
+++ /home/afsoon/results/libtiff-final/libtiff-bug-2007-11-02-371336d-865f7b2/libtiff.tif_dirwrite.c	2017-02-18 13:40:12.653723614 -0500
@@ -327,13 +327,12 @@
 
 		if (tif->tif_flags & TIFF_POSTENCODE)
 		{
-			tif->tif_flags &= ~TIFF_POSTENCODE;
-			if (!(*tif->tif_postencode)(tif))
-			{
-				TIFFErrorExt(tif->tif_clientdata,module,
-				    "Error post-encoding before directory write");
-				return (0);
-			}
+			if (tif->tif_rawcc > 0 && !TIFFFlushData1(tif)) {
+		    TIFFError(tif->tif_name,
+			"Error flushing data before directory write");
+		    return (0);
+	    }
+
 		}
 		(*tif->tif_close)(tif);       /* shutdown encoder */
 		/*
